# Dependências

## Introdução

Este notebook foi desenvolvido para auxiliar os servidores da Superintendência de Tecnologia da Informação (STI) da Faculdade de Filosofia, Letras e Ciências Humanas ([FFLCH](https://www.fflch.usp.br/)) da Universidade de São Paulo ([USP](https://www5.usp.br/)) na instalação e teste dos softwares necessários para o curso **Introdução à Linguagem de Programação R**.

O repositório do curso está disponível no [GitHub](https://github.com/danielvartan/r-course). Os slides das aulas podem ser acessados em [danielvartan.github.io/r-course](https://danielvartan.github.io/r-course/).

Agradeço à equipe da STI pelo suporte e colaboração.

## Como Usar

Siga os passos abaixo para instalar e testar os softwares necessários para o curso:

1. Instale todas as dependências listadas abaixo.
2. Abra este notebook no [Positron](https://positron.posit.co/).
3. Configure a chave PAT na variável de ambiente `GITHUB_PAT` (veja instruções abaixo).
4. Execute, em ordem, os blocos de código da seção *Pacotes/Importações* para instalar os pacotes necessários.
5. Execute, em ordem, os blocos de código da seção *Teste* para verificar se tudo está funcionando corretamente.

No Positron, é possível executar, em ordem, todos os blocos de código de uma vez, pressionando `Ctrl`+`Shift`+`P` e buscando por `Quarto: Run All Cells`.

Se ocorrer algum problema durante os testes, confira se todos os pacotes foram instalados corretamente.

O instrutor do curso está disponível para ajudar via e-mail ou WhatsApp.

## Dependências

O curso se baseia em cinco ferramentas: O sistema de versionamento [Git](https://git-scm.com/); a linguagem de programação [R](https://cran.r-project.org/); os ambientes de desenvolvimento integrado (IDE) [RStudio](https://posit.co/download/rstudio-desktop/) e [Positron](https://positron.posit.co/); e o sistema de notebooks computacionais [Quarto](https://quarto.org/docs/get-started/). Abaixo estão as versões mínimas necessárias para cada uma dessas ferramentas.

- Git >= 2.52.0
- R >= 4.5.2
- RStudio Desktop >= 2026.01
- Positron >= 2026.01
- Quarto >= 1.8.27

Todos os softwares devem ser instalados usando **inglês** como idioma da interface. Instale todas as dependências antes de seguir para as próximas etapas.

## PAT

Para evitar problemas com o [rate limit](https://docs.github.com/en/rest/using-the-rest-api/rate-limits-for-the-rest-api?apiVersion=2022-11-28) da API do GitHub, é necessário cadastrar um Personal Access Token ([PAT](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-fine-grained-personal-access-token)) na variável de ambiente `GITHUB_PAT`. Um PAT temporário será fornecido pelo instrutor, mas qualquer PAT com acesso a repositórios públicos irá funcionar.

Insira o PAT fornecido na função abaixo e execute o bloco de código para registrar essa variável temporariamente na sessão do R.

```{r}
Sys.setenv(GITHUB_PAT = "COLOQUE_O_PAT_AQUI")
```

## Pacotes/Importações

Com todas as dependências instaladas, instale os pacotes necessários executando os blocos código abaixo.

### Atualizações

Primeiramente, atualize todos os pacotes instalados no sistema com:

```{r}
update.packages(ask = FALSE)
```

### Variáveis

Esta variável de ambiente é necessária para evitar problemas com a biblioteca `arrow`.

```{r}
Sys.setenv(LIBARROW_MINIMAL = "false")
```

### Tidyverse

```{r}
install.packages(
  c(
    "dplyr",
    "forcats",
    "fs",
    "ggplot2",
    "googledrive",
    "googlesheets4",
    "haven",
    "hms",
    "lubridate",
    "magrittr",
    "purrr",
    "readr",
    "readxl",
    "rvest",
    "stringr",
    "tibble",
    "tidyr"
  ),
  dependencies = TRUE
)
```

Instale também o meta-pacote, por via das dúvidas (o metapacote não contém todos os pacotes da coleção):

```{r}
install.packages("tidyverse", dependencies = TRUE)
```

### Tidymodels

```{r}
install.packages(
  c(
    "broom",
    "corrr",
    "infer",
    "parsnip",
    "recipes",
    "rsample",
    "textrecipes",
    "tidyposterior",
    "workflows",
    "yardstick"
  ),
  dependencies = TRUE
)
```

Instale também o meta-pacote, por via das dúvidas (o metapacote não contém todos os pacotes da coleção):

```{r}
install.packages("tidymodels", dependencies = TRUE)
```

### R Infrastructure (R-Lib)

```{r}
install.packages(
  c(
    "askpass",
    "cli",
    "devtools",
    "here",
    "httr",
    "httr2",
    "lintr",
    "nanoparquet",
    "ragg",
    "remotes",
    "rlang",
    "scales",
    "testthat",
    "usethis",
    "vroom",
    "withr",
    "xml2",
    "yaml",
    "zip"
  ),
  dependencies = TRUE
)
```

### rOpenSci

```{r}
install.packages(
  c(
    "mctq",
    "osfr"
  ),
  dependencies = TRUE
)
```

### RStudio

```{r}
install.packages(
  c(
    "DT",
    "gt",
    "htmltools",
    "leaflet",
    "renv",
    "rmarkdown"
  ),
  dependencies = TRUE
)
```

### r-spatial

```{r}
install.packages(
  c(
    "sf",
    "stars"
  ),
  dependencies = TRUE
)
```

### rspatial

```{r}
install.packages(
  c(
    "geodata",
    "raster",
    "terra"
  ),
  dependencies = TRUE
)
```

### IpeaGIT

```{r}
install.packages(
  c(
    "censobr",
    "enderecobr",
    "geobr",
    "geocodebr"
  ),
  dependencies = TRUE
)
```

### easystats

```{r}
install.packages(
  c(
    "effectsize",
    "performance",
    "report"
  ),
  dependencies = TRUE
)
```

### Outros

```{r}
install.packages(
  c(
    "anthro",
    "arrow",
    "beepr",
    "car",
    "checkmate",
    "clipr",
    "curl",
    "fBasics",
    "GGally",
    "ggblend",
    "ggplotify",
    "ggspatial",
    "janitor",
    "jsonlite",
    "knitr",
    "labelled",
    "latex2exp",
    "microbenchmark",
    "moments",
    "multcomp",
    "nortest",
    "numbersBR",
    "olsrr",
    "palmerpenguins",
    "pander",
    "patchwork",
    "psychometric",
    "pwr",
    "pwrss",
    "quartabs",
    "RColorBrewer",
    "sidrar",
    "skedastic",
    "summarytools",
    "tictoc",
    "viridis"
  ),
  dependencies = TRUE
)
```

### GitHub

Para instalar pacotes remotos, é preciso instalar o pacote `remotes`:

```{r}
install.packages("remotes", dependencies = TRUE)
```

```{r}
remotes::install_github(
  c(
    "danielvartan/brandr",
    "danielvartan/groomr",
    "danielvartan/lockr",
    "danielvartan/orbis",
    "danielvartan/prettycheck",
    "danielvartan/quartor",
    "danielvartan/rutils"
  ),
  dependencies = TRUE,
  upgrade = "always"
)
```

## Testes

Execute os blocos de código abaixo, em ordem, para verificar se todos os pacotes foram instalados corretamente.

### Gráficos

```{r}
library(brandr)
library(dplyr)
library(GGally)
library(ggplot2)
library(palmerpenguins)
library(patchwork)
library(stringr)
library(tidyr)
```

```{r}
penguins |>
  ggplot(aes(x = island, fill = species)) +
  geom_bar(alpha = 0.8) +
  theme_minimal() +
  facet_wrap(~species, ncol = 1) +
  coord_flip() +
  labs(
    x = "Island",
    y = "Count"
  ) +
  scale_fill_brand_d() +
  theme(legend.position = "none")
```

```{r}
penguins |>
  drop_na(flipper_length_mm, species) |>
  ggplot(aes(x = flipper_length_mm, fill = species)) +
  geom_histogram(bins = 30, alpha = 0.5, position = "identity") +
  labs(x = "Flipper Length (mm)", y = "Frequency", fill = "Species") +
  scale_fill_brand_d()
```

```{r}
penguins |>
  drop_na(bill_length_mm, species) |>
  ggplot(aes(x = species, y = bill_length_mm, fill = species)) +
  geom_boxplot(outlier.color = get_brand_color("dark-red")) +
  geom_jitter(width = 0.2, alpha = 0.1) +
  scale_fill_brand_d(alpha = 0.7) +
  labs(x = "Species", y = "Bill Length (mm)", fill = "Species")
```

```{r}
penguins |>
  drop_na(flipper_length_mm, body_mass_g, species) |>
  ggplot(
    aes(
      x = flipper_length_mm,
      y = body_mass_g,
      color = species,
      shape = species
    )
  ) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(
    x = "Flipper Length (mm)",
    y = "Body Mass (g)",
    color = "Species",
    shape = "Species"
  ) +
  scale_color_brand_d(alpha = 0.7)
```

```{r}
penguins |>
  drop_na(flipper_length_mm, body_mass_g, sex) |>
  mutate(sex = `levels<-`(sex, str_to_title(levels(sex)))) |>
  ggplot(aes(x = flipper_length_mm, y = body_mass_g, color = sex)) +
  geom_point(size = 2) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    color = get_brand_color("brown")
  ) +
  labs(
    x = "Flipper Length (mm)",
    y = "Body Mass (g)",
    color = "Sex"
  ) +
  scale_color_brand_d(alpha = 0.7) +
  facet_wrap(~species)
```

```{r}
plot_hist <-
  penguins |>
  drop_na(flipper_length_mm, species) |>
  ggplot(aes(x = flipper_length_mm, fill = species)) +
  geom_histogram(bins = 30, alpha = 0.5, position = "identity") +
  labs(x = "Flipper Length (mm)", y = "Frequency") +
  scale_fill_brand_d() +
  theme(legend.position = "none")
```

```{r}
plot_boxplot <-
  penguins |>
  drop_na(bill_length_mm, species) |>
  ggplot(aes(x = species, y = bill_length_mm, fill = species)) +
  geom_boxplot(outlier.color = get_brand_color("dark-red")) +
  geom_jitter(width = 0.2, alpha = 0.1) +
  labs(x = "Species", y = "Bill Length (mm)", fill = "Species") +
  scale_fill_brand_d(alpha = 0.7) +
  theme(axis.title.x = element_blank(), legend.position = "none")
```

```{r}
plot_scatter <-
  penguins |>
  drop_na(flipper_length_mm, body_mass_g, species) |>
  ggplot(
    aes(
      x = flipper_length_mm,
      y = body_mass_g,
      color = species,
      shape = species
    )
  ) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(
    x = "Flipper Length (mm)",
    y = "Body Mass (g)",
    color = "Species",
    shape = "Species"
  ) +
  scale_color_brand_d(alpha = 0.7) +
  theme(legend.position = "none")
```

```{r}
(plot_hist + plot_boxplot) / plot_scatter + plot_annotation(tag_levels = "A")
```

```{r}
penguins |>
  dplyr::select(species, body_mass_g, ends_with("_mm")) |>
  ggpairs(aes(color = species)) +
  scale_color_brand_d(alpha = 0.7) +
  scale_fill_brand_d(alpha = 0.7)
```

### Modelos

```{r}
library(car)
library(dplyr)
library(effectsize)
library(infer)
library(multcomp)
library(palmerpenguins)
library(pwrss)
library(stats)
library(tidyr)
```

```{r}
observed_statistic <-
  penguins |>
  filter(species %in% c("Adelie", "Gentoo")) |>
  drop_na(flipper_length_mm, species) |>
  specify(flipper_length_mm ~ species) |>
  hypothesize(null = "independence") |>
  calculate("t", order = c("Adelie", "Gentoo"))
```

```{r}
observed_statistic
```

```{r}
null_dist <-
  penguins |>
  filter(species %in% c("Adelie", "Gentoo")) |>
  drop_na(flipper_length_mm, species) |>
  specify(flipper_length_mm ~ species) |>
  hypothesize(null = "independence") |>
  generate(reps = 1000, type = "permute") |>
  calculate("t", order = c("Adelie", "Gentoo"))
```

```{r}
null_dist
```

```{r}
null_dist |>
  visualize() +
  shade_p_value(
    obs_stat = observed_statistic,
    direction = "two-sided"
  )
```

```{r}
null_dist |>
  get_p_value(
    obs_stat = observed_statistic,
    direction = "two-sided"
  )
```

```{r}
adelie <-
  penguins |>
  filter(species == "Adelie") |>
  drop_na(flipper_length_mm) |>
  pull(flipper_length_mm)
```

```{r}
gentoo <-
  penguins |>
  filter(species == "Gentoo") |>
  drop_na(flipper_length_mm) |>
  pull(flipper_length_mm)
```

```{r}
test <- t.test(
  x = adelie,
  y = gentoo,
  alternative = "two.sided",
  mu = 0,
  paired = FALSE,
  var.equal = FALSE, # Welch's t-test,
  conf.level = 0.95
)
```

```{r}
test
```

```{r}
effect_size <-
  cohens_d(
    x = adelie,
    y = gentoo,
    mu = 0,
    adjust = TRUE, # Hedge's g
    ci = 0.95,
    alternative = "two.sided"
  )
```

```{r}
effect_size
```

```{r}
effect_size |> interpret_hedges_g(rules = "cohen1988")
```

```{r}
pwrss.t.2means(
  mu1 = adelie |> mean(na.rm = TRUE),
  mu2 = gentoo |> mean(na.rm = TRUE),
  sd1 = adelie |> sd(na.rm = TRUE),
  sd2 = gentoo |> sd(na.rm = TRUE),
  paired = FALSE,
  n2 = gentoo |> length(),
  kappa = (adelie |> length()) / (gentoo |> length()),
  power = NULL,
  alpha = 0.05,
  welch.df = TRUE,
  alternative = "not equal"
)
```

```{r}
fit <- aov(flipper_length_mm ~ species, data = penguins)
```

```{r}
fit
```

```{r}
fit |> summary()
```

```{r}
fit |> TukeyHSD()
```

```{r}
effect_size <- fit |> eta_squared()
```

```{r}
effect_size
```

```{r}
effect_size |> interpret_eta_squared(rules = "cohen1992")
```

```{r}
fit <- aov(flipper_length_mm ~ body_mass_g * species, data = penguins)
```

```{r}
fit
```

```{r}
fit |> Anova(type = "III")
```

```{r}
post_hoc <-
  fit |>
  glht(linfct = mcp(species = "Tukey"))
```

```{r}
summary(post_hoc)
```

### Projeto SISVAN

```{r}
library(curl)
library(dplyr)
library(readxl)
library(stringr)
library(tidyr)
```

```{r}
file <- tempfile()
```

```{r}
paste0(
  "https://sisaps.saude.gov.br/sisvan/public/file/relatorios/",
  "consumo/2oumais/entre2a4anos/CONS_ULTRA.xlsx"
) |>
  curl_download(file)
```

```{r}
#| output: false

data <- NULL

for (i in 2015:2022) {
  data_i <-
    file |>
    read_xlsx(
      sheet = as.character(i),
      skip = 1,
      col_types = "text",
      col_names = FALSE
    ) |>
    slice(-1)

  if (!i == 2022) {
    data_i <- data_i |> dplyr::select(-1, -2)
  }

  data_i <-
    data_i |>
    rename_with(~ paste0("x", seq(length(.x)))) |>
    mutate(year = i) |>
    relocate(year)

  data <- bind_rows(data, data_i)
}
```

```{r}
data <-
  data |>
  rename(
    state_abbrev = x1,
    municipality_code = x2,
    municipality_name = x3,
    n_upf = x4,
    n_upf_rel = x5,
    n_monitored = x6
  ) |>
  mutate(
    municipality_code = as.integer(municipality_code),
    municipality_name = str_to_title(municipality_name),
    n_upf = as.integer(n_upf),
    n_monitored = as.integer(n_monitored)
  )
```

```{r}
data <-
  data |>
  filter(
    !n_upf > n_monitored,
    n_monitored >= 10,
    !state_abbrev == "DF"
  ) |>
  drop_na(n_upf, n_monitored) |>
  mutate(n_upf_rel = n_upf / n_monitored)
```

```{r}
data <-
  data |>
  mutate(
    misfs = case_when(
      state_abbrev %in%
        c(
          "AC",
          "GO",
          "MS",
          "MT",
          "RO",
          "TO"
        ) ~ "A",
      state_abbrev %in%
        c(
          "ES",
          "MG",
          "PR",
          "RJ",
          "RS",
          "SC",
          "SP"
        ) ~ "B",
      state_abbrev %in%
        c(
          "AL",
          "BA",
          "CE",
          "MA",
          "PB",
          "PE",
          "PI",
          "RN",
          "SE"
        ) ~ "C",
      state_abbrev %in%
        c(
          "AM",
          "AP",
          "PA",
          "RR"
        ) ~ "D",
    ),
    misfs = factor(misfs, levels = c("A", "B", "C", "D"))
  ) |>
  relocate(misfs, .before = state_abbrev)
```

```{r}
data |> glimpse()
```
